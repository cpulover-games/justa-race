<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justa Race</title>
</head>

<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <script>
        // fundamental
        /** @type {HTMLCanvasElement} */ // declare type in VSCode (for code completion)
        var canvas;
        /** @type {CanvasRenderingContext2D} */
        var canvasContext;
        const FPS = 30;
        const BG_COLOR = "black";
        const COLORS = ["green", "yellow", "red"]; // to randomize element color
        var indexColor = 0;

        // car
        var carPic = document.createElement("img");
        var carPicLoaded = false;
        var carX;
        var carY;
        var carSpeedX;
        var carSpeedY;
        const BALL_SIZE = 10;
        var carColor;

        // track
        const TRACK_COLS = 20;
        const TRACK_ROWS = 15;
        var trackGrid = [ // 0: empty, 1: track, 2: player
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
            1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1,
            1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
            1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1,
            1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
            1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
            1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
            1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
            1, 0, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1,
            1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
        ];
        const TRACK_WIDTH = 40;
        const TRACK_HEIGHT = 40;
        const TRACK_GAP = 2;
        var trackColor;

        // mouse
        var mouseX;
        var mouseY;
        const TEXT_COLOR = "yellow";

        // setup script
        window.onload = function () {
            canvas = document.getElementById("gameCanvas");
            canvasContext = canvas.getContext("2d");

            // load assets
            carPic.src = "player1car.png";
            carPic.onload = function () {
                carPicLoaded = true;
            }

            initGame();

            setInterval(updateAll, 1000 / FPS); // invoke updateAll() fps times/second

            // events
            canvas.addEventListener('mousemove', updateMousePos);
        }

        /* INITIALIZATION */
        function initGame() {
            initColors();
            initCar();
        }

        function initColors() {
            // indexColor=0;
            carColor = COLORS[indexColor];
            trackColor = COLORS[indexColor];
        }

        function initCar() {
            carSpeedX = 4;
            carSpeedY = 4;
            for (currentRow = 0; currentRow < TRACK_ROWS; currentRow++) {
                for (currentCol = 0; currentCol < TRACK_COLS; currentCol++) {
                    var indexArray = colRowToIndexArray(currentCol, currentRow);
                    if (trackGrid[indexArray] == 2) {
                        trackGrid[indexArray] = 0; // to prevent car from stucking due to collision
                        carX = currentCol * TRACK_WIDTH + TRACK_WIDTH / 2;
                        carY = currentRow * TRACK_HEIGHT + TRACK_HEIGHT / 2;
                    }
                }
            }
        }
        /* END OF INITIALIZATION */

        function updateAll() {
            moveAll();
            drawAll();
            trackCarCollision();
        }

        /* COLLISION */
        function trackCarCollision() {
            // indicate which col and row of trackGrid[] the car are in
            var carTrackCol = Math.floor(carX / TRACK_WIDTH);
            var carTrackRow = Math.floor(carY / TRACK_HEIGHT);
            // convert to index array with col and row
            var trackIndexUnderCar = colRowToIndexArray(carTrackCol, carTrackRow);

            // boundaries of col and row
            if (carTrackCol >= 0 && carTrackCol < TRACK_COLS &&
                carTrackRow >= 0 && carTrackRow < TRACK_ROWS &&
                trackGrid[trackIndexUnderCar]) { // collision happens if track is not hidden

                var previousCarX = carX - carSpeedX;
                var previousCarY = carY - carSpeedY;
                var previousCarTrackCol = Math.floor(previousCarX / TRACK_WIDTH);
                var previousCarTrackRow = Math.floor(previousCarY / TRACK_WIDTH);

                var armpitCase = true;

                // column changes when car hits front of the track
                if (previousCarTrackCol != carTrackCol) {
                    // track right/left to hit track is on the previous column, same row
                    var adjHorizontalTrackIndex = colRowToIndexArray(previousCarTrackCol, carTrackRow);
                    // if the adjacent track not exist, allow car to bound horizontally
                    if (!trackGrid[adjHorizontalTrackIndex]) {
                        carSpeedX *= -1;
                        armpitCase = false;
                    }
                }
                // row changes when car hits side of the track
                if (previousCarTrackRow != carTrackRow) {
                    // track above/below to hit track is on the same column, previous row
                    var adjVerticalTrackIndex = colRowToIndexArray(carTrackCol, previousCarTrackRow);
                    // if the adjacent track not exist, allow car to bound vertically
                    if (!trackGrid[adjVerticalTrackIndex]) {
                        carSpeedY *= -1;
                        armpitCase = false;
                    }
                }

                // prevent car go through if armpit case
                if (armpitCase) {
                    carSpeedX *= -1;
                    carSpeedY *= -1;
                }
                // both changes when car hits the corner => change both speeds
            }
        }
        /* END OF COLLISION */

        /* DRAWING */
        function drawAll() {
            // big frame (draw every time to clear screen)
            colorRect(0, 0, canvas.width, canvas.height, BG_COLOR);

            // car
            if (carPicLoaded) {
                canvasContext.drawImage(carPic, carX - carPic.width / 2, carY - carPic.height / 2);
            }
            // tracks
            drawTracks();
            // mouse position
            colorText(mouseX + ", " + mouseY, mouseX, mouseY, TEXT_COLOR);
        }

        /* EVENTS */
        function updateMousePos(event) {
            //???
            var rect = canvas.getBoundingClientRect();
            var root = document.documentElement;

            mouseX = event.clientX - rect.left - root.scrollLeft;
            mouseY = event.clientY - rect.top - root.scrollTop;
            // cheat();
        }

        function cheat() {
            // cheat for testing: make car follow the mouse
            carX = mouseX;
            carY = mouseY;
            carSpeedX = 5;
            carSpeedY = -5;
        }
        /* END OF EVENTS */

        /* DRAWING HELPERS */
        function colorRect(topX, topY, boxWidth, boxHeight, fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.fillRect(topX, topY, boxWidth, boxHeight);
        }

        function colorCircle(centerX, centerY, radius, fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.beginPath();
            canvasContext.arc(centerX, centerY, radius, 0, Math.PI * 2, true);
            canvasContext.fill();
        }

        function colorText(text, textX, textY, fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.fillText(text, textX, textY);
        }

        function drawTracks() {
            for (currentRow = 0; currentRow < TRACK_ROWS; currentRow++) {
                for (currentCol = 0; currentCol < TRACK_COLS; currentCol++) {
                    var indexArray = colRowToIndexArray(currentCol, currentRow);
                    if (trackGrid[indexArray] == 1) {
                        colorRect(TRACK_WIDTH * currentCol, TRACK_HEIGHT * currentRow, TRACK_WIDTH - TRACK_GAP,
                            TRACK_HEIGHT -
                            TRACK_GAP, trackColor);
                    }
                }
            }
        }

        // convert to index of trackGrid[] when know its col and row
        function colRowToIndexArray(col, row) {
            return col + row * TRACK_COLS;
        }
        /* END OF DRAWING HELPERS */

        /* MOTION */
        function moveAll() {
            // update element position
            carX += carSpeedX;
            carY += carSpeedY;
            // boundations (collision with big frame)
            if (carX < BALL_SIZE && carSpeedX < 0 || // car hits left
                carX > canvas.width - BALL_SIZE && carSpeedX > 0) { // car hits right
                carSpeedX *= -1;
            }
            if (carY < BALL_SIZE && carSpeedY < 0) { // car hits top
                carSpeedY *= -1;
            }
            /* Game Over: car hits bottom */
            if (carY > canvas.height - BALL_SIZE) {
                initGame();
            }
        }
    </script>
</body>

</html>